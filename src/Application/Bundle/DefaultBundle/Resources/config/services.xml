<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="application.admin.user.class">Application\Bundle\DefaultBundle\Admin\UserAdmin</parameter>
        <parameter key="application.admin.user.entity">Application\Bundle\DefaultBundle\Entity\User</parameter>
        <parameter key="application.admin.user.controller">SonataAdminBundle:CRUD</parameter>
        <parameter key="application.user_manager.class">Application\Bundle\DefaultBundle\Model\UserManager</parameter>
        <!--<parameter key="application.user_login.listener.class">Application\Bundle\DefaultBundle\EventListener\UserLoginListener</parameter>-->
        <parameter key="application.admin.event.class">Application\Bundle\DefaultBundle\Admin\EventAdmin</parameter>
        <parameter key="application.admin.event.entity">Application\Bundle\DefaultBundle\Entity\Event</parameter>
        <parameter key="application.admin.event.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.speaker.class">Application\Bundle\DefaultBundle\Admin\SpeakerAdmin</parameter>
        <parameter key="application.admin.speaker.entity">Application\Bundle\DefaultBundle\Entity\Speaker</parameter>
        <parameter key="application.admin.speaker.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.event_page.class">Application\Bundle\DefaultBundle\Admin\EventPageAdmin</parameter>
        <parameter key="application.admin.event_page.entity">Application\Bundle\DefaultBundle\Entity\EventPage</parameter>
        <parameter key="application.admin.event_page.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.reviews.class">Application\Bundle\DefaultBundle\Admin\ReviewAdmin</parameter>
        <parameter key="application.admin.reviews.entity">Application\Bundle\DefaultBundle\Entity\Review</parameter>
        <parameter key="application.admin.reviews.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.mails.class">Application\Bundle\DefaultBundle\Admin\MailAdmin</parameter>
        <parameter key="application.admin.mails.entity">Application\Bundle\DefaultBundle\Entity\Mail</parameter>
        <parameter key="application.admin.mails.controller">ApplicationDefaultBundle:MailAdmin</parameter>

        <parameter key="application.admin.tickets.class">Application\Bundle\DefaultBundle\Admin\TicketAdmin</parameter>
        <parameter key="application.admin.tickets.entity">Application\Bundle\DefaultBundle\Entity\Ticket</parameter>
        <parameter key="application.admin.tickets.controller">ApplicationDefaultBundle:TicketCRUD</parameter>

        <parameter key="application.admin.mail_queue.class">Application\Bundle\DefaultBundle\Admin\MailQueueAdmin</parameter>
        <parameter key="application.admin.mail_queue.entity">Application\Bundle\DefaultBundle\Entity\MailQueue</parameter>
        <parameter key="application.admin.mail_queue.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.promo_code.class">Application\Bundle\DefaultBundle\Admin\PromoCodeAdmin</parameter>
        <parameter key="application.admin.promo_code.entity">Application\Bundle\DefaultBundle\Entity\PromoCode</parameter>
        <parameter key="application.admin.promo_code.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.payment.class">Application\Bundle\DefaultBundle\Admin\PaymentAdmin</parameter>
        <parameter key="application.admin.payment.entity">Application\Bundle\DefaultBundle\Entity\Payment</parameter>
        <parameter key="application.admin.payment.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.qr_code.class">Endroid\QrCode\QrCode</parameter>

        <parameter key="application.mailer_helper.class">Application\Bundle\DefaultBundle\Helper\StfalconMailerHelper</parameter>

        <parameter key="application.promo_code.form.type.class">Application\Bundle\DefaultBundle\Form\Type\PromoCodeFormType</parameter>

        <parameter key="application.listener.payment.class">Application\Bundle\DefaultBundle\EventListener\PaymentListener</parameter>

        <parameter key="application.payment_manager.class">Application\Bundle\DefaultBundle\Entity\PaymentManager</parameter>

        <parameter key="application.admin.page.class">Application\Bundle\DefaultBundle\Admin\PageAdmin</parameter>
        <parameter key="application.admin.page.entity">Application\Bundle\DefaultBundle\Entity\Page</parameter>
        <parameter key="application.admin.sponsor.class">Application\Bundle\DefaultBundle\Admin\SponsorAdmin</parameter>
        <parameter key="application.admin.sponsor.entity">Application\Bundle\DefaultBundle\Entity\Sponsor</parameter>
        <parameter key="application.admin.sponsor.controller">SonataAdminBundle:CRUD</parameter>


        <parameter key="application.admin.event_sponsor.class">Application\Bundle\DefaultBundle\Admin\EventSponsorAdmin</parameter>
        <parameter key="application.admin.event_sponsor.entity">Application\Bundle\DefaultBundle\Entity\EventSponsor</parameter>
        <parameter key="application.admin.event_sponsor.controller">SonataAdminBundle:CRUD</parameter>

        <parameter key="application.admin.category.class">Application\Bundle\DefaultBundle\Admin\CategoryAdmin</parameter>
        <parameter key="application.admin.category.entity">Application\Bundle\DefaultBundle\Entity\Category</parameter>
        <parameter key="application.admin.category.controller">SonataAdminBundle:CRUD</parameter>

    </parameters>

    <services>
        <service id="application.payment.service" class="Application\Bundle\DefaultBundle\Service\PaymentService">
            <argument type="service" id="service_container"/>
        </service>

        <service id="application.referral.service" class="Application\Bundle\DefaultBundle\Service\ReferralService">
            <argument type="service" id="service_container"/>
        </service>

        <service id="sonata.block.service.statistic" class="Application\Bundle\DefaultBundle\Service\StatisticBlockService">
            <tag name="sonata.block" />
            <argument>sonata.block.service.statistic</argument>
            <argument type="service" id="templating"/>
        </service>

        <service id="application.menu_builder" class="Application\Bundle\DefaultBundle\Menu\MenuBuilder">
            <argument type="service" id="knp_menu.factory" />
            <argument type="service" id="translator" />
            <argument>%jms_i18n_routing.locales%</argument>
            <argument type="service" id="security.token_storage" />
            <argument type="service" id="mobile_detect.mobile_detector" />
        </service>

        <!-- main menu -->
        <service id="application.menu.main"
                 class="Knp\Menu\MenuItem"
                 scope="request"
                 factory-service="application.menu_builder"
                 factory-method="createMainMenu">
            <tag name="knp_menu.menu" alias="main" />
            <argument type="service" id="request" />
        </service>

        <!-- sub menu on pages of event -->
        <service id="application.menu.event_sub"
                 class="Knp\Menu\MenuItem"
                 scope="request"
                 factory-service="application.menu_builder"
                 factory-method="createEventSubMenu">
            <tag name="knp_menu.menu" alias="event_sub" />
            <argument type="service" id="request" />
            <argument type="service" id="application.current_event" />
        </service>

        <!-- main menu -->
        <service id="application.menu.main.redesign"
                 class="Knp\Menu\MenuItem"
                 scope="request"
                 factory-service="application.menu_builder"
                 factory-method="createMainMenuRedesign">
            <tag name="knp_menu.menu" alias="main_redesign" />
            <argument type="service" id="request" />
        </service>

        <service id="application.menu.main.login.redesign"
                 class="Knp\Menu\MenuItem"
                 scope="request"
                 factory-service="application.menu_builder"
                 factory-method="createLoginMenu">
            <tag name="knp_menu.menu" alias="login_redesign" />
            <argument type="service" id="request" />
        </service>

        <service id="twig.extension.intl" class="Twig_Extensions_Extension_Intl">
            <tag name="twig.extension" />
        </service>

        <service id="application.locale_url.listener" class="Application\Bundle\DefaultBundle\EventListener\LocaleUrlResponseListener">
            <tag name="kernel.event_listener" event="kernel.exception" method="onKernelException" priority="128" />
            <tag name="kernel.event_listener" event="kernel.request" method="onKernelRequest" priority="128" />
            <argument>%jms_i18n_routing.default_locale%</argument>
            <argument>%jms_i18n_routing.locales%</argument>
            <argument>%jms_i18n_routing.cookie.name%</argument>
            <argument type="service" id="router" />
            <argument type="service" id="maxmind.geoip" />
            <argument type="service" id="logger" />
        </service>

        <service id="application.sonata.locales.required" class="Application\Bundle\DefaultBundle\Service\GetSonataLocalsRequiredService">
            <argument>%jms_i18n_routing.default_locale%</argument>
            <argument>%jms_i18n_routing.locales%</argument>
        </service>

        <service id="app_liip_cache_resolve_command" class="Application\Bundle\DefaultBundle\Command\AppResolveLiipCacheCommand">
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

<!--fix sonata Circular reference detected for service "knp_menu.matcher"-->
        <service id="sonata.admin.menu.matcher.voter.children" class="Sonata\AdminBundle\Menu\Matcher\Voter\ChildrenVoter">
            <argument type="service" id="knp_menu.matcher"/>
        </service>

        <service id="vich_uploader.my_storage.flysystem" class="Application\Bundle\DefaultBundle\Service\MyFlySystemStorage">
            <argument type="service" id="vich_uploader.property_mapping_factory" />
            <argument type="service" id="oneup_flysystem.mount_manager" />
        </service>

        <service id="liip_imagine.cache.resolver.prototype.flysystem" class="Application\Bundle\DefaultBundle\Service\MyFlySystemResolver" public="true" abstract="true">
            <argument><!-- will be injected by a ResolverFactory --></argument>
            <argument type="service" id="router.request_context" />
            <argument><!-- will be injected by a ResolverFactory --></argument>
            <argument><!-- will be injected by a ResolverFactory --></argument>
            <argument><!-- will be injected by a ResolverFactory --></argument>
        </service>

        <!-- SonataAdminBundle users settings -->
        <service id="application.admin.user" class="%application.admin.user.class%">
            <tag name="sonata.admin" manager_type="orm" group="Пользователи" label="Пользователи"/>
            <argument />
            <argument>%application.admin.user.entity%</argument>
            <argument>%application.admin.user.controller%</argument>
        </service>

        <!-- registration form type -->
        <service id="application.registration.form.type" class="Application\Bundle\DefaultBundle\Form\Type\RegistrationFormType">
            <tag name="form.type" alias="application_registration" />
            <argument>%fos_user.model.user.class%</argument>
        </service>

        <!-- profile form type -->
        <service id="application.profile.form.type" class="Application\Bundle\DefaultBundle\Form\Type\ProfileFormType">
            <tag name="form.type" alias="application_profile" />
            <argument>%fos_user.model.user.class%</argument>
        </service>
        <!-- profile form handler -->
        <service id="application.profile.form.handler" class="Application\Bundle\DefaultBundle\Form\Handler\ProfileFormHandler" scope="request" public="false">
            <argument type="service" id="fos_user.profile.form" />
            <argument type="service" id="request" />
            <argument type="service" id="fos_user.user_manager" />
        </service>

        <service id="application.user_manager" class="%application.user_manager.class%">
            <argument type="service" id="security.encoder_factory" />
            <argument type="service" id="fos_user.util.username_canonicalizer" />
            <argument type="service" id="fos_user.util.email_canonicalizer" />
            <argument type="service" id="fos_user.entity_manager" />
            <argument>%fos_user.model.user.class%</argument>
            <argument type="service" id="service_container" />
        </service>

        <service id="fos_user.registration.form.handler" class="Application\Bundle\DefaultBundle\Services\RegistrationFormWithGoogleCaptcha">
            <argument type="service" id="fos_user.registration.form" />
            <argument type="service" id="request_stack" />
            <argument type="service" id="fos_user.user_manager" />
            <argument type="service" id="fos_user.mailer" />
            <argument type="service" id="fos_user.util.token_generator" />
            <argument type="service" id="logger" />
            <argument>%google_captcha_secret_key%</argument>
            <argument type="service" id="buzz" />
            <argument>%kernel.environment%</argument>
        </service>

        <service id="application.admin.page" class="%application.admin.page.class%">
            <tag name="sonata.admin" manager_type="orm" group="Страницы" label="Страницы"/>
            <argument />
            <argument>%application.admin.page.entity%</argument>
            <argument />
        </service>

        <service id="user_mail_command_service" class="Application\Bundle\DefaultBundle\Command\StfalconMailerCommand">
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <service id="trans_command_service" class="Application\Bundle\DefaultBundle\Command\StfalconChangeTranslationCommand">
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <service id="recalculate_ticket_sold_command_service" class="Application\Bundle\DefaultBundle\Command\StfalconRecalculateTicketSoldCountCommand">
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <service id="application.admin.mail_admin" class="%application.admin.mails.class%">
            <tag name="mail_admin" manager_type="orm" />
            <argument />
            <argument>%application.admin.mails.entity%</argument>
            <argument>%application.admin.mails.controller%</argument>
        </service>

        <service id="application.current_event" class="%application.admin.event.entity%" />

        <service id="application.admin.event" class="%application.admin.event.class%">
            <tag name="sonata.admin" manager_type="orm" group="События" label="События"/>
            <argument />
            <argument>%application.admin.event.entity%</argument>
            <argument>%application.admin.event.controller%</argument>
        </service>

        <service id="application.admin.event_group" class="Application\Bundle\DefaultBundle\Admin\EventGroupAdmin">
            <tag name="sonata.admin" manager_type="orm" group="События" label="Групы"/>
            <argument />
            <argument>Application\Bundle\DefaultBundle\Entity\EventGroup</argument>
            <argument />
        </service>

        <service id="application.admin.reviews" class="%application.admin.reviews.class%">
            <tag name="sonata.admin" manager_type="orm" group="События" label="Доклады"/>
            <argument />
            <argument>%application.admin.reviews.entity%</argument>
            <argument>%application.admin.reviews.controller%</argument>
        </service>

        <service id="application.admin.speaker" class="%application.admin.speaker.class%">
            <tag name="sonata.admin" manager_type="orm" group="События" label="Докладчики"/>
            <argument />
            <argument>%application.admin.speaker.entity%</argument>
            <argument>%application.admin.speaker.controller%</argument>
        </service>

        <service id="application.admin.event_page" class="%application.admin.event_page.class%">
            <tag name="sonata.admin" manager_type="orm" group="События" label="Страницы"/>
            <argument />
            <argument>%application.admin.event_page.entity%</argument>
            <argument>%application.admin.event_page.controller%</argument>
        </service>


        <service id="application.admin.mails" class="%application.admin.mails.class%">
            <tag name="sonata.admin" manager_type="orm" group="Рассылки" label="Рассылки"/>
            <argument />
            <argument>%application.admin.mails.entity%</argument>
            <argument>%application.admin.mails.controller%</argument>
            <call method="addChild">
                <argument type="service" id="application.admin.mail_queue" />
            </call>
        </service>

        <service id="application.admin.mail_queue" class="%application.admin.mail_queue.class%">
            <tag name="sonata.admin" manager_type="orm" group="Рассылки" label="Очередь" />
            <argument />
            <argument>%application.admin.mail_queue.entity%</argument>
            <argument>%application.admin.mail_queue.controller%</argument>
        </service>

        <service id="application.admin.tickets" class="%application.admin.tickets.class%">
            <tag name="sonata.admin" manager_type="orm" group="Билеты" label="Билеты"/>
            <argument />
            <argument>%application.admin.tickets.entity%</argument>
            <argument>%application.admin.tickets.controller%</argument>
        </service>

        <service id="application.admin.payment" class="%application.admin.payment.class%">
            <tag name="sonata.admin" manager_type="orm" group="Билеты" label="Платежи"/>
            <argument />
            <argument>%application.admin.payment.entity%</argument>
            <argument>%application.admin.payment.controller%</argument>
        </service>

        <service id="application.admin.promo_code" class="%application.admin.promo_code.class%">
            <tag name="sonata.admin" manager_type="orm" group="Билеты" label="Промо коды"/>
            <argument />
            <argument>%application.admin.promo_code.entity%</argument>
            <argument>%application.admin.promo_code.controller%</argument>
        </service>

        <service id="application.qr_code" class="%application.qr_code.class%">
        </service>

        <service id="application.mailer_helper" class="%application.mailer_helper.class%">
            <argument type="service" id="twig"/>
            <argument type="service" id="doctrine.orm.entity_manager"/>
            <argument type="service" id="router"/>
            <argument type="service" id="mailer"/>
        </service>

        <service id="application.promo_code.form.type" class="Application\Bundle\DefaultBundle\Form\Type\PromoCodeFormType">
            <tag name="form.type" alias="application_promo_code" />
        </service>

        <service id="application.ticket.form.type" class="Application\Bundle\DefaultBundle\Form\Type\TicketFormType">
            <tag name="form.type" alias="application_ticket" />
        </service>

        <service id="application.listener.payment" class="%application.listener.payment.class%">
            <tag name="doctrine.event_listener" event="postUpdate" method="postUpdate"/>
            <argument type="service" id="service_container"/>
        </service>


        <service id="application.admin.event_sponsor" class="%application.admin.event_sponsor.class%">
            <tag name="sonata.admin" manager_type="orm"  show_in_dashboard="false" />
            <argument />
            <argument>%application.admin.event_sponsor.entity%</argument>
            <argument>%application.admin.event_sponsor.controller%</argument>
        </service>

        <service id="application.current_sponsor" class="%application.admin.sponsor.entity%" />

        <service id="application.admin.sponsor" class="%application.admin.sponsor.class%">
            <tag name="sonata.admin" manager_type="orm" group="Спонсоры" label="Спонсоры"/>
            <argument />
            <argument>%application.admin.sponsor.entity%</argument>
            <argument>%application.admin.sponsor.controller%</argument>
        </service>
        <service id="application.admin.category" class="%application.admin.category.class%">
            <tag name="sonata.admin" manager_type="orm" group="Спонсоры" label="Категории"/>
            <argument />
            <argument>%application.admin.category.entity%</argument>
            <argument>%application.admin.category.controller%</argument>
        </service>
    </services>
</container>
